<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scriptle</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; background: #f4f4f4; }
        .container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        .clues { margin-bottom: 2rem; }
        .clue { background: #eee; padding: 1rem; margin-bottom: 0.5rem; border-left: 4px solid #333; }
        .clue-label { font-weight: bold; font-size: 0.8rem; color: #666; display: block; margin-bottom: 0.25rem; }
        .clue-text { font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; }
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
        select, button { padding: 0.5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }
        select:disabled { background: #e9ecef; border-color: #28a745; color: #155724; font-weight: bold; }
        button { background: #333; color: white; border: none; cursor: pointer; }
        button:hover { background: #555; }
        .message { margin-top: 1rem; padding: 1rem; border-radius: 4px; text-align: center; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .attempts { text-align: center; margin-top: 0.5rem; color: #666; }
        .loading { text-align: center; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Scriptle</h1>
        <p style="text-align:center">Guess the Movie and the Character saying the first line.</p>

        <div id="loading" class="loading">Loading script data...</div>

        <div id="game-area" style="display:none;">
            <div id="clues" class="clues"></div>

            <div id="game-controls">
                <div class="input-group">
                    <select id="movie-select">
                        <option value="">Select Movie...</option>
                    </select>
                    <select id="char-select" disabled>
                        <option value="">Select Character...</option>
                    </select>
                    <button id="guess-btn">Guess</button>
                </div>
                <div class="attempts">Attempts: <span id="attempt-count">0</span>/5</div>
            </div>

            <div id="message" class="message" style="display: none;"></div>

            <button id="next-day-btn" style="display:none; width:100%; margin-top:1rem; padding:1rem; background:#28a745; color: white; border:none; cursor:pointer;">Come back tomorrow!</button>
        </div>
    </div>

    <script>
        // Simple seeded RNG (Mulberry32)
        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            }
        }

        // Generate seed from date string YYYY-MM-DD
        function getDateSeed() {
            const today = new Date().toISOString().split('T')[0];
            // Simple hash of the date string
            let hash = 0;
            for (let i = 0; i < today.length; i++) {
                hash = ((hash << 5) - hash) + today.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash); // Ensure positive
        }

        let scriptData = [];
        let metadata = { movies: [], characters: {} };
        let targetIndex = -1;
        let currentAttempt = 0;
        let gameOver = false;
        let movieLocked = false;

        async function initGame() {
            try {
                const response = await fetch('script.json');
                scriptData = await response.json();
                processMetadata();
                selectDailyLine();
                renderGame();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('game-area').style.display = 'block';
            } catch (e) {
                document.getElementById('loading').textContent = "Error loading game data.";
                console.error(e);
            }
        }

        function processMetadata() {
            const moviesSet = new Set();
            const charMap = {};

            scriptData.forEach(line => {
                const m = line.movie;
                const c = line.character;
                moviesSet.add(m);
                if (!charMap[m]) charMap[m] = new Set();
                charMap[m].add(c);
            });

            metadata.movies = Array.from(moviesSet).sort();
            metadata.characters = {};
            for (const m in charMap) {
                metadata.characters[m] = Array.from(charMap[m]).sort();
            }

            populateMovies();
        }

        function populateMovies() {
            const select = document.getElementById('movie-select');
            metadata.movies.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                select.appendChild(opt);
            });
            select.addEventListener('change', onMovieChange);
        }

        function onMovieChange() {
            const movie = document.getElementById('movie-select').value;
            const charSelect = document.getElementById('char-select');
            charSelect.innerHTML = '<option value="">Select Character...</option>';

            if (movie && metadata.characters[movie]) {
                metadata.characters[movie].forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    charSelect.appendChild(opt);
                });
                charSelect.disabled = false;
            } else {
                charSelect.disabled = true;
            }
        }

        function selectDailyLine() {
            const seed = getDateSeed();
            const rng = mulberry32(seed);

            // Filter indices that have at least 2 following lines
            const validCount = scriptData.length - 2;
            const randomVal = rng();
            targetIndex = Math.floor(randomVal * validCount);

            console.log("Game Seed:", seed, "Target Index:", targetIndex);
        }

        function renderGame() {
            // Restore state if we saved it? For now, just render based on currentAttempt = 0
            updateAttempts(currentAttempt);
            renderClues();
        }

        function renderClues() {
            const container = document.getElementById('clues');
            container.innerHTML = '';

            const clues = [];
            const targetLine = scriptData[targetIndex];

            // Always Line 1
            clues.push({ label: "Line 1", content: targetLine.text });

            if (currentAttempt >= 1) {
                clues.push({ label: "Line 2", content: scriptData[targetIndex + 1].text });
            }
            if (currentAttempt >= 2) {
                const c = scriptData[targetIndex + 1];
                clues.push({ label: `Character (${c.original_character || c.character})`, content: c.character });
            }
            if (currentAttempt >= 3) {
                clues.push({ label: "Line 3", content: scriptData[targetIndex + 2].text });
            }
            if (currentAttempt >= 4) {
                const c = scriptData[targetIndex + 2];
                clues.push({ label: `Character (${c.original_character || c.character})`, content: c.character });
            }

            clues.forEach(clue => {
                const div = document.createElement('div');
                div.className = 'clue';
                div.innerHTML = `
                    <span class="clue-label">${clue.label}</span>
                    <div class="clue-text">${clue.content}</div>
                `;
                container.appendChild(div);
            });
        }

        function updateAttempts(count) {
            document.getElementById('attempt-count').textContent = count;
        }

        function showMessage(msg, type) {
            const el = document.getElementById('message');
            el.textContent = msg;
            el.className = 'message ' + type;
            el.style.display = 'block';
        }

        function submitGuess() {
            if (gameOver) return;

            const movieSelect = document.getElementById('movie-select');
            const charSelect = document.getElementById('char-select');

            const movieGuess = movieSelect.value;
            const charGuess = charSelect.value;

            if (!movieGuess) {
                showMessage("Please select a movie.", "error");
                return;
            }
            if (!charGuess) {
                showMessage("Please select a character.", "error");
                return;
            }

            const targetLine = scriptData[targetIndex];
            const targetMovie = targetLine.movie;
            const targetChar = targetLine.character.toUpperCase(); // Data is upper, but ensure

            const movieCorrect = (movieGuess === targetMovie);
            const charCorrect = (charGuess.toUpperCase() === targetChar);

            if (movieCorrect) {
                movieLocked = true;
                movieSelect.disabled = true;
            } else {
                if (!movieLocked) {
                    movieSelect.value = "";
                    onMovieChange();
                }
            }

            if (movieCorrect && charCorrect) {
                showMessage(`Correct! It was ${targetLine.character} in ${targetLine.movie}.`, 'success');
                gameOver = true;
                endGame();
            } else {
                currentAttempt++;
                if (currentAttempt >= 5) {
                    showMessage(`Game Over! It was ${targetLine.character} in ${targetLine.movie}.`, 'error');
                    gameOver = true;
                    endGame();
                } else {
                    let msg = "Incorrect.";
                    if (movieCorrect) msg = "Movie is correct! Character is wrong.";
                    showMessage(msg + " New clue revealed!", 'error');
                    renderClues();
                    updateAttempts(currentAttempt);
                    charSelect.value = "";
                }
            }
        }

        function endGame() {
            document.getElementById('game-controls').style.display = 'none';
            document.getElementById('next-day-btn').style.display = 'block';
            renderClues(); // Ensure all clues for the state are shown (or maybe show all? No, just the ones revealed)
        }

        document.getElementById('guess-btn').addEventListener('click', submitGuess);

        initGame();
    </script>
</body>
</html>
