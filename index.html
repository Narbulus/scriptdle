<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scriptle - Harry Potter Edition</title>
    <style>
        :root {
            --primary-color: #333;
            --bg-color: #f4f4f4;
            --container-bg: white;
            --accent-color: #555;
            --btn-text: white;
            --highlight: #e2e2e2;
        }

        body.theme-hp {
            --primary-color: #740001; /* Gryffindor Red */
            --bg-color: #1a1a1a;
            --container-bg: #f8f8f8;
            --accent-color: #d3a625; /* Gold */
            --btn-text: white;
        }

        body.theme-shrek {
            --primary-color: #4c6827; /* Ogre Green */
            --bg-color: #e0f0d0;
            --container-bg: #fff;
            --accent-color: #8c5a2b; /* Brown */
            --btn-text: white;
        }

        body.theme-lotr {
            --primary-color: #2b4a3b; /* Elven Green */
            --bg-color: #1e1e1e;
            --container-bg: #f0f5f0;
            --accent-color: #c9a050; /* Gold */
            --btn-text: white;
        }

        body.theme-miyazaki {
            --primary-color: #4a90e2; /* Sky Blue */
            --bg-color: #e6f3ff;
            --container-bg: #fff;
            --accent-color: #ff9a9e; /* Pink */
            --btn-text: white;
        }

        body.theme-comedy {
            --primary-color: #9b59b6; /* Purple */
            --bg-color: #fce4ec;
            --container-bg: #fff;
            --accent-color: #e67e22; /* Orange */
            --btn-text: white;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            background: var(--bg-color);
            line-height: 1.2;
            transition: background 0.3s;
        }
        .container {
            background: var(--container-bg);
            padding: 3rem;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            font-family: sans-serif;
            color: var(--primary-color);
            margin-bottom: 2rem;
        }

        /* Series Selector */
        .series-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            gap: 1rem;
        }
        .series-tab {
            padding: 0.5rem 1rem;
            border: 2px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            background: #eee;
            font-family: sans-serif;
            font-weight: bold;
            color: #333;
        }
        .series-tab.active {
            background: var(--primary-color);
            color: var(--btn-text);
            border-color: var(--accent-color);
        }

        /* Script formatting */
        .script-line {
            margin-bottom: 1.5rem;
        }
        .character-name {
            text-align: center;
            font-weight: bold;
            margin-bottom: 0.2rem;
            text-transform: uppercase;
            width: 50%;
            margin-left: auto;
            margin-right: auto;
            color: #000;
        }
        .dialogue-text {
            width: 70%;
            margin-left: auto;
            margin-right: auto;
            white-space: pre-wrap;
            color: #000;
        }
        .action-text {
            width: 80%;
            margin-left: auto;
            margin-right: auto;
            font-style: italic;
        }

        /* Controls */
        .controls-top {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            font-family: sans-serif;
        }
        .controls-bottom {
            text-align: center;
            margin-top: 2rem;
            font-family: sans-serif;
        }

        select, button {
            padding: 0.5rem;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background: var(--primary-color);
            color: var(--btn-text);
            border: none;
            cursor: pointer;
        }
        button:hover { filter: brightness(1.2); }

        .message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            font-family: sans-serif;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }

        .char-select-inline {
            display: block;
            width: 100%;
            text-align-last: center;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            text-transform: uppercase;
        }

        .context-line {
            opacity: 0.7;
            background: rgba(0,0,0,0.05);
            padding: 0.5rem 0;
        }

        /* Share Button */
        #share-container {
            text-align: center;
            margin-top: 1.5rem;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        #share-btn {
            background: #28a745;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        #share-btn:hover {
            background: #218838;
        }

        #share-preview {
            font-family: sans-serif;
            background: #fff;
            padding: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            white-space: pre-wrap;
            text-align: center;
            min-width: 200px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }

        /* Mobile Responsiveness */
        @media (max-width: 600px) {
            body {
                margin: 0;
                padding: 0.5rem;
            }
            .container {
                padding: 1rem;
            }
            h1 {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
            .character-name, .dialogue-text, .action-text {
                width: 100%;
            }
            .controls-top {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            select, button {
                width: 100%;
                box-sizing: border-box;
                max-width: none !important;
            }
            #movie-select {
                max-width: none !important;
            }
            .controls-bottom {
                margin-top: 1.5rem;
            }
            .series-tabs {
                gap: 0.5rem;
            }
            .series-tab {
                padding: 0.5rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="theme-hp">
    <div class="container">
        <h1>Scriptle</h1>

        <div id="loading" style="text-align:center; font-family:sans-serif;">Loading script...</div>

        <div id="game-area" style="display:none;">
            <div class="series-tabs" style="flex-wrap: wrap;">
                <div class="series-tab active" data-series="Harry Potter" onclick="switchSeries('Harry Potter')">Harry Potter</div>
                <div class="series-tab" data-series="Shrek" onclick="switchSeries('Shrek')">Shrek</div>
                <div class="series-tab" data-series="Lord of the Rings" onclick="switchSeries('Lord of the Rings')">Lord of the Rings</div>
                <div class="series-tab" data-series="Miyazaki" onclick="switchSeries('Miyazaki')">Miyazaki</div>
                <div class="series-tab" data-series="Early 2000s Comedies" onclick="switchSeries('Early 2000s Comedies')">2000s Comedies</div>
            </div>

            <div class="controls-top">
                <select id="movie-select" style="max-width:300px;">
                    <option value="">Select Movie...</option>
                </select>
                <!-- Randomize button removed -->
            </div>

            <div id="script-display">
                <!-- Script lines injected here -->
            </div>

            <div id="game-controls" class="controls-bottom">
                <button id="guess-btn">Guess</button>
                <div style="margin-top:0.5rem; color:#666;">Attempts: <span id="attempt-count">0</span>/5</div>
            </div>

            <div id="message" class="message" style="display: none;"></div>

            <div id="share-container">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Share Preview:</div>
                <div id="share-preview"></div>
                <button id="share-btn">Copy to Clipboard ðŸ“‹</button>
            </div>
        </div>
    </div>

    <script>
        // Simple seeded RNG
        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            }
        }

        function getDateSeed() {
            const today = new Date().toISOString().split('T')[0];
            let hash = 0;
            for (let i = 0; i < today.length; i++) {
                hash = ((hash << 5) - hash) + today.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash);
        }

        let fullData = {};
        let currentSeries = "Harry Potter";
        let scriptData = [];
        let metadata = { movies: [], characters: {} };
        let targetIndex = -1;
        let currentAttempt = 0;
        let gameOver = false;
        let movieLocked = false;
        let salt = 3170;
        let guessHistory = [];

        async function initGame() {
            try {
                const response = await fetch('script.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                fullData = await response.json();

                // If the JSON is old format (array), wrap it
                if (Array.isArray(fullData)) {
                     fullData = { "Harry Potter": fullData, "Shrek": [] };
                }

                switchSeries("Harry Potter");

                document.getElementById('loading').style.display = 'none';
                document.getElementById('game-area').style.display = 'block';
            } catch (e) {
                document.getElementById('loading').innerHTML =
                    '<span style="color:red; font-weight:bold;">Error loading game data.</span><br><br>' +
                    'If you are running this locally, you need a local web server.<br>' +
                    'Try: python -m http.server';
                console.error(e);
            }
        }

        function switchSeries(seriesName) {
            currentSeries = seriesName;
            scriptData = fullData[seriesName] || [];

            // Theme Switching
            if (seriesName === "Shrek") document.body.className = "theme-shrek";
            else if (seriesName === "Lord of the Rings") document.body.className = "theme-lotr";
            else if (seriesName === "Miyazaki") document.body.className = "theme-miyazaki";
            else if (seriesName === "Early 2000s Comedies") document.body.className = "theme-comedy";
            else document.body.className = "theme-hp";

            // UI Update
            document.querySelectorAll('.series-tab').forEach(tab => {
                if (tab.dataset.series === seriesName) tab.classList.add('active');
                else tab.classList.remove('active');
            });

            if (scriptData.length === 0) {
                // If empty, warn but don't break
                console.warn(`No data for ${seriesName}`);
            }

            processMetadata();
            startNewGame();
        }

        function processMetadata() {
            const moviesSet = new Set();
            const charMap = {};

            scriptData.forEach(line => {
                const m = line.movie;
                const c = line.character;
                moviesSet.add(m);
                if (!charMap[m]) charMap[m] = new Set();
                charMap[m].add(c);
            });

            metadata.movies = Array.from(moviesSet).sort();
            metadata.characters = {};
            for (const m in charMap) {
                metadata.characters[m] = Array.from(charMap[m]).sort();
            }

            const select = document.getElementById('movie-select');
            select.innerHTML = '<option value="">Select Movie...</option>';
            metadata.movies.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                select.appendChild(opt);
            });
            select.addEventListener('change', onMovieChange);
        }

        function onMovieChange() {
            const movie = document.getElementById('movie-select').value;
            const charSelect = document.getElementById('char-select');

            // If charSelect doesn't exist yet (not rendered), wait
            if (!charSelect) return;

            const currentVal = charSelect.value;
            charSelect.innerHTML = '<option value="">(SELECT CHARACTER)</option>';

            if (movie && metadata.characters[movie]) {
                metadata.characters[movie].forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    charSelect.appendChild(opt);
                });
                charSelect.disabled = false;
                // Try to restore value if still valid
                if (currentVal && metadata.characters[movie].includes(currentVal)) {
                    charSelect.value = currentVal;
                }
            } else {
                charSelect.disabled = true;
            }
        }

        function startNewGame() {
            currentAttempt = 0;
            gameOver = false;
            movieLocked = false;
            guessHistory = [];

            // Seed logic with salt + series name to allow different daily games
            const dateSeed = getDateSeed();
            // Simple string hash for series
            let seriesHash = 0;
            for(let i=0; i<currentSeries.length; i++) seriesHash += currentSeries.charCodeAt(i);

            const combinedSeed = dateSeed + salt + seriesHash;
            const rng = mulberry32(combinedSeed);

            // Filter valid indices (must have some padding for context)
            const minIndex = 1;
            const maxIndex = scriptData.length - 6;

            if (maxIndex < minIndex) {
                // Not enough data
                targetIndex = 0;
                return;
            }

            const randomVal = rng();
            targetIndex = minIndex + Math.floor(randomVal * (maxIndex - minIndex));

            console.log("Game Seed:", combinedSeed, "Target Index:", targetIndex);

            document.getElementById('message').style.display = 'none';
            document.getElementById('game-controls').style.display = 'block';
            document.getElementById('share-container').style.display = 'none';
            document.getElementById('movie-select').disabled = false;
            document.getElementById('movie-select').value = "";

            renderScript();
            onMovieChange(); // Reset chars
        }

        function renderScript() {
            const container = document.getElementById('script-display');
            container.innerHTML = '';

            if (!scriptData || scriptData.length === 0) {
                container.innerHTML = '<div style="text-align:center;">No script data available for this series.</div>';
                return;
            }

            // End Game Logic: Show context
            if (gameOver) {
                renderLine(targetIndex - 1, true); // Preceding
                renderLine(targetIndex, false);   // Target (Revealed)
                for (let i = 1; i <= 5; i++) {
                     renderLine(targetIndex + i, true);
                }
                updateSharePreview();
                return;
            }

            // Game Logic
            // Target Line
            const targetLine = scriptData[targetIndex];
            const div = document.createElement('div');
            div.className = 'script-line';

            // Character Dropdown
            const charDiv = document.createElement('div');
            charDiv.className = 'character-name';

            const select = document.createElement('select');
            select.id = 'char-select';
            select.className = 'char-select-inline';
            select.innerHTML = '<option value="">(SELECT CHARACTER)</option>';
            select.disabled = true; // Enabled by onMovieChange
            charDiv.appendChild(select);

            const textDiv = document.createElement('div');
            textDiv.className = 'dialogue-text';
            textDiv.textContent = targetLine.text;

            div.appendChild(charDiv);
            div.appendChild(textDiv);
            container.appendChild(div);

            // Subsequent Lines (Clues)
            if (currentAttempt >= 1) renderClueLine(targetIndex + 1, currentAttempt >= 2);
            if (currentAttempt >= 3) renderClueLine(targetIndex + 2, currentAttempt >= 4);
        }

        function renderClueLine(idx, revealChar) {
            if (idx >= scriptData.length) return;
            const line = scriptData[idx];
            const div = document.createElement('div');
            div.className = 'script-line';

            const charDiv = document.createElement('div');
            charDiv.className = 'character-name';
            charDiv.textContent = revealChar ? line.character : "???";

            const textDiv = document.createElement('div');
            textDiv.className = 'dialogue-text';
            textDiv.textContent = line.text;

            div.appendChild(charDiv);
            div.appendChild(textDiv);
            document.getElementById('script-display').appendChild(div);
        }

        function renderLine(idx, isContext) {
            if (idx < 0 || idx >= scriptData.length) return;
            const line = scriptData[idx];
            const div = document.createElement('div');
            div.className = 'script-line';
            if (isContext) div.classList.add('context-line');

            const charDiv = document.createElement('div');
            charDiv.className = 'character-name';
            charDiv.textContent = line.character;

            const textDiv = document.createElement('div');
            textDiv.className = 'dialogue-text';
            textDiv.textContent = line.text;

            div.appendChild(charDiv);
            div.appendChild(textDiv);
            document.getElementById('script-display').appendChild(div);
        }

        function updateAttempts(count) {
            document.getElementById('attempt-count').textContent = count;
        }

        function showMessage(msg, type) {
            const el = document.getElementById('message');
            el.textContent = msg;
            el.className = 'message ' + type;
            el.style.display = 'block';
        }

        function generateShareString(success) {
            const date = new Date().toISOString().split('T')[0];
            const attemptCount = success ? currentAttempt + 1 : 'X';
            let grid = `Scriptle (${currentSeries}) ${date} ${attemptCount}/5 ðŸŽ¬\n\n`;

            // Two rows: Movies and Characters
            let movieRow = "";
            let charRow = "";

            for (let i = 0; i < 5; i++) {
                if (i < guessHistory.length) {
                    const guess = guessHistory[i];

                    // Movie
                    if (guess.movie) movieRow += "ðŸŸ¢";
                    else movieRow += "âš«";

                    // Character
                    if (guess.char) charRow += "ðŸŸ¢";
                    else charRow += "âš«";

                } else {
                    // Empty slots
                    movieRow += "âšª"; // White Circle for unused
                    charRow += "âšª";
                }
            }

            grid += movieRow + "\n" + charRow;
            grid += "\n\n" + window.location.href;
            return grid;
        }

        function updateSharePreview() {
            const success = gameOver && (guessHistory.length > 0 && guessHistory[guessHistory.length - 1].char && guessHistory[guessHistory.length - 1].movie);
            const shareText = generateShareString(success);
            document.getElementById('share-preview').textContent = shareText;
        }

        function submitGuess() {
            if (gameOver) return;

            const movieSelect = document.getElementById('movie-select');
            const charSelect = document.getElementById('char-select');

            const movieGuess = movieSelect.value;
            const charGuess = charSelect.value;

            if (!movieGuess) {
                showMessage("Please select a movie.", "error");
                return;
            }
            if (!charGuess) {
                showMessage("Please select a character.", "error");
                return;
            }

            const targetLine = scriptData[targetIndex];
            const targetMovie = targetLine.movie;
            const targetChar = targetLine.character.toUpperCase();

            const movieCorrect = (movieGuess === targetMovie);
            const charCorrect = (charGuess.toUpperCase() === targetChar);

            guessHistory.push({
                movie: movieCorrect,
                char: charCorrect
            });

            if (movieCorrect) {
                movieLocked = true;
                movieSelect.disabled = true;
            } else {
                if (!movieLocked) {
                    movieSelect.value = "";
                    onMovieChange();
                }
            }

            if (movieCorrect && charCorrect) {
                showMessage(`Correct! It was ${targetLine.character} in ${targetLine.movie}.`, 'success');
                gameOver = true;
                renderScript(); // Renders end game state
                document.getElementById('game-controls').style.display = 'none';
                document.getElementById('share-container').style.display = 'flex'; // Flex for centering
            } else {
                currentAttempt++;
                updateAttempts(currentAttempt);
                if (currentAttempt >= 5) {
                    showMessage(`Game Over! It was ${targetLine.character} in ${targetLine.movie}.`, 'error');
                    gameOver = true;
                    renderScript(); // Renders end game state
                    document.getElementById('game-controls').style.display = 'none';
                    document.getElementById('share-container').style.display = 'flex';
                } else {
                    let msg = "Incorrect.";
                    if (movieCorrect) msg = "Movie is correct! Character is wrong.";
                    showMessage(msg + " New clue revealed!", 'error');
                    renderScript(); // Renders next clue
                    onMovieChange(); // Re-bind dropdown
                    if (movieLocked) {
                         document.getElementById('char-select').value = "";
                    }
                }
            }
        }

        document.getElementById('guess-btn').addEventListener('click', submitGuess);

        // Randomize button removed

        document.getElementById('share-btn').addEventListener('click', async () => {
             const success = guessHistory.length > 0 && guessHistory[guessHistory.length - 1].char && guessHistory[guessHistory.length - 1].movie;
             const shareText = generateShareString(success);
             try {
                 await navigator.clipboard.writeText(shareText);
                 const btn = document.getElementById('share-btn');
                 const originalText = btn.textContent;
                 btn.textContent = "Copied! âœ…";
                 setTimeout(() => btn.textContent = originalText, 2000);
             } catch (err) {
                 console.error('Failed to copy: ', err);
                 alert("Failed to copy to clipboard.\n\n" + shareText);
             }
        });

        initGame();
    </script>
</body>
</html>
