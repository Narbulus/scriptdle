#!/usr/bin/env node
// Bundles puzzle data into scriptlegame/webroot/data/ for the Reddit WebView.
// The WebView can only fetch from 'self' due to Reddit's CSP.
// Copies directly from local public/data/ (generated by generate-daily-puzzles.py).

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const LOCAL_DATA = path.resolve(__dirname, '../public/data');
const WEBROOT = path.resolve(__dirname, '../scriptlegame/webroot/data');
const WEBROOT_ROOT = path.resolve(__dirname, '../scriptlegame/webroot');

function main() {
  // Bundle packs-full.json (contains theme data)
  fs.mkdirSync(WEBROOT, { recursive: true });

  // Copy favicon to webroot
  const faviconSrc = path.resolve(__dirname, '../favicon.png');
  if (fs.existsSync(faviconSrc)) {
    fs.copyFileSync(faviconSrc, path.join(WEBROOT_ROOT, 'favicon.png'));
    console.log('  Bundled favicon.png');
  }
  const packsSrc = path.join(LOCAL_DATA, 'packs-full.json');
  if (fs.existsSync(packsSrc)) {
    fs.copyFileSync(packsSrc, path.join(WEBROOT, 'packs-full.json'));
    console.log('  Bundled packs-full.json');
  } else {
    console.error('  Missing packs-full.json — run generate:daily first');
    process.exit(1);
  }

  // Bundle all daily-all puzzle files
  const localDailyDir = path.join(LOCAL_DATA, 'daily-all');
  const webrootDailyDir = path.join(WEBROOT, 'daily-all');
  fs.mkdirSync(webrootDailyDir, { recursive: true });

  if (!fs.existsSync(localDailyDir)) {
    console.error('  Missing daily-all/ directory — run generate:daily first');
    process.exit(1);
  }

  const files = fs.readdirSync(localDailyDir).filter(f => f.endsWith('.json'));
  for (const file of files) {
    fs.copyFileSync(path.join(localDailyDir, file), path.join(webrootDailyDir, file));
  }

  console.log(`Bundled packs + ${files.length} days of puzzle data into webroot.`);

  // Generate per-pack HTML files with themed loading backgrounds.
  // Each pack gets a copy of index.html with --loading-bg set to the pack's bgColor.
  const indexHtml = path.join(WEBROOT_ROOT, 'index.html');
  if (fs.existsSync(indexHtml) && fs.existsSync(packsSrc)) {
    const html = fs.readFileSync(indexHtml, 'utf-8');
    const packsData = JSON.parse(fs.readFileSync(packsSrc, 'utf-8'));
    const packs = packsData.packs || [];
    let count = 0;

    for (const pack of packs) {
      if (!pack.id || !pack.theme?.bgColor) continue;
      const themed = html.replace('--loading-bg: #1a1a1a', `--loading-bg: ${pack.theme.bgColor}`);
      fs.writeFileSync(path.join(WEBROOT_ROOT, `${pack.id}.html`), themed);
      count++;
    }

    console.log(`Generated ${count} per-pack themed HTML files.`);
  }
}

main();
